{% extends "analytics/base.html" %}
{% load static %}

{% block title %}My Analyses{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/my_analyses.css' %}">
<h1>My Analyses</h1>

{% if analyses %}
  <div class="analysis-list">
    {% for a in analyses %}
      <div
        class="analysis-card"
        data-url="{% url 'analysis_dashboard' analysis_id=a.id %}"
        onclick="window.location.href=this.dataset.url"
      >
        <div class="analysis-card-left">
          <div class="analysis-repo-name">{{ a.repository.name }}</div>
          <div class="analysis-meta">
            <span class="analysis-mined-label">Mined:</span>
            <span class="analysis-mined-at">{{ a.mined_at }}</span>
          </div>
        </div>

        <div class="analysis-card-right">
          <!-- Delete button that opens modal "delete-btn-small"-->
          <button
            class="analysis-json-pill"
            onclick="event.stopPropagation(); openDeleteModal('{{ a.id }}', '{{ a.repository.name }}', '{{ a.mined_at }}');"
          >
            Delete
          </button>
          <a
            class="analysis-json-pill"
            href="{% url 'analysis_refresh' analysis_id=a.id %}"
            onclick="event.stopPropagation();"
          >
            Refresh Analysis
          </a>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No analyses yet. Run one from <a href="{% url 'home' %}">Home</a>.</p>
{% endif %}

<!-- ðŸ”µ SINGLE MODAL â€” outside the loop -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal">
      <h2>Delete Analysis</h2>

      <p>Are you sure you want to delete the analysis for:</p>

      <div class="confirm-box">
          <strong id="repoName"></strong><br>
          <span id="minedAt"></span>
      </div>

      <p>This action cannot be undone.</p>

      <form id="deleteForm" method="POST">
          {% csrf_token %}
          <button class="delete-btn" type="submit">Yes, Delete Permanently</button>
          <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
      </form>
  </div>
</div>

<script>
function openDeleteModal(id, repoName, minedAt) {
    document.getElementById("repoName").innerText = repoName;
    document.getElementById("minedAt").innerText = "Mined: " + minedAt;

    document.getElementById("deleteForm").action =
        `/analysis/${id}/delete/`;

    document.getElementById("deleteModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("deleteModal").style.display = "none";
}
</script>

{% endblock %}
